// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String?  @unique
  password  String?  // Hashed
  nick      String?
  name      String?
  phone     String?
  discord   String?
  telegram  String?  // Telegram Chat ID or Username
  role      String   @default("user") // admin, friend, user
  score     Int      @default(0)
  
  tierId    String?
  tier      Tier?    @relation(fields: [tierId], references: [id])
  
  managerId String?
  manager   User?    @relation("UserToManager", fields: [managerId], references: [id])
  users     User[]   @relation("UserToManager") // Sub-users (friends)

  assignedTasks Task[] @relation("Assignee")
  assignments   TaskAssignment[]
  tags          Tag[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Task {
  id          String   @id @default(cuid())
  subject     String
  description String?
  file        String?
  status      String   @default("PENDING") // PENDING, WAITING_APPROVAL, IN_PROGRESS, WAITING_VERIFICATION, COMPLETED, CANCELLED
  reward      String?  // Changed to String
  duration    DateTime?
  
  tierId      String?
  tier        Tier?    @relation(fields: [tierId], references: [id])
  
  tags        Tag[]

  assigneeId  String?
  assignee    User?    @relation("Assignee", fields: [assigneeId], references: [id])

  assignments TaskAssignment[]

  // Targeting
  targetType     String   @default("all")
  targetUserIds  String?  // JSON string e.g. ["u1", "u2"]
  targetTopCount Int?
  
  proofUrl    String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TaskAssignment {
  id        String   @id @default(cuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  status    String   @default("ASSIGNED") // ASSIGNED, ACCEPTED, REJECTED, IN_PROGRESS, COMPLETED, FAILED
  score     Int?
  note      String?
  proofUrl  String?
  
  assignedAt  DateTime @default(now())
  acceptedAt  DateTime?
  completedAt DateTime?

  @@unique([userId, taskId])
}

model Tag {
  id    String @id @default(cuid())
  name  String @unique
  tasks Task[]
  users User[]
}

model Tier {
  id            String @id @default(cuid())
  name          String @unique
  requiredScore Int    @default(0)
  users         User[]
  tasks         Task[]
}
